<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>After-School Lessons</title>
  <meta name="description" content="CST3144 After-School Lessons app built with Vue 2 (CDN). Browse, search, sort and book lessons with a simple cart and checkout.">
  <meta name="theme-color" content="#2563eb">
  <link rel="icon" href="https://fav.farm/ðŸŽ“" />
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Vue 2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app">
    <div class="min-h-screen py-8 px-4">
      <div class="max-w-7xl mx-auto">
        <!-- Error Banner -->
        <div v-if="errorMessage" class="mb-4 p-4 rounded-lg border border-red-300 bg-red-50 text-red-700" role="alert" aria-live="polite">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-2">
              <i class="fas fa-triangle-exclamation"></i>
              <span class="font-semibold">{{ errorMessageTitle }}</span>
            </div>
            <button @click="errorMessage = ''" class="text-red-600 hover:text-red-800 focus:outline-none" aria-label="Dismiss error">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <p class="mt-1">{{ errorMessage }}</p>
        </div>
        <!-- Header -->
        <header class="text-center mb-8">
          <h1 class="text-4xl font-bold text-gray-800 mb-2">After-School Lessons</h1>
          <p class="text-gray-600">Browse and book after-school classes for your children</p>
        </header>

        <!-- Shopping Cart Button -->
        <div class="flex justify-end mb-6">
          <button
            @click="showCart = !showCart"
            :disabled="!showCart && cart.length === 0"
            :class="[
              'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-green-500',
              showCart || cart.length > 0
                ? 'bg-green-600 text-white hover:bg-green-700 cursor-pointer'
                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            ]"
          >
            <i class="fas fa-shopping-cart"></i>
            {{ showCart ? 'View Lessons' : 'View Cart' }}
            <span v-if="cart.length > 0" class="bg-white text-green-600 rounded-full px-2 py-1 text-sm">
              {{ cart.length }}
            </span>
          </button>
        </div>

        <!-- Lessons View -->
        <div v-if="!showCart">
          <!-- Search Bar -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <label for="search-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Search Lessons
            </label>
            <div class="relative">
              <input
                id="search-input"
                type="text"
                v-model="searchQuery"
                @input="handleSearch"
                placeholder="Search by subject, location, price, or spaces..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <i class="fas fa-search absolute right-4 top-4 text-gray-400"></i>
            </div>
            <p v-if="searchQuery" class="text-sm text-gray-500 mt-2">
              Searching for: "{{ searchQuery }}"
            </p>
          </div>

          <!-- Sort Controls -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Sort by</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Sort Attribute -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Attribute</label>
                <div class="space-y-2">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="sortAttribute" value="subject" v-model="sortBy" class="mr-2" />
                    <span class="text-gray-700">Subject</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="sortAttribute" value="location" v-model="sortBy" class="mr-2" />
                    <span class="text-gray-700">Location</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="sortAttribute" value="price" v-model="sortBy" class="mr-2" />
                    <span class="text-gray-700">Price</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="sortAttribute" value="spaces" v-model="sortBy" class="mr-2" />
                    <span class="text-gray-700">Availability (Spaces)</span>
                  </label>
                </div>
              </div>

              <!-- Sort Order -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Order</label>
                <div class="space-y-2">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="sortOrder" value="asc" v-model="sortOrder" class="mr-2" />
                    <span class="text-gray-700">Ascending</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="sortOrder" value="desc" v-model="sortOrder" class="mr-2" />
                    <span class="text-gray-700">Descending</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div v-if="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="text-gray-600 mt-4">Loading lessons...</p>
          </div>

          <!-- Lessons Grid -->
          <div v-else-if="displayedLessons.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Lesson Card Component -->
            <div v-for="lesson in displayedLessons" :key="lesson._id" 
                 class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300">
              <div class="flex justify-center mb-4">
                <i :class="`fas ${lesson.icon} text-4xl text-blue-600`"></i>
              </div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">{{ lesson.subject }}</h3>
              <p class="text-gray-600 mb-1">
                <i class="fas fa-map-marker-alt mr-2"></i>{{ lesson.location }}
              </p>
              <p class="text-gray-600 mb-1">
                <i class="fas fa-pound-sign mr-2"></i>{{ lesson.price }}
              </p>
              <p class="text-gray-600 mb-4" :class="{ 'text-red-600 font-semibold': lesson.spaces === 0 }">
                <i class="fas fa-users mr-2"></i>{{ lesson.spaces }} spaces available
              </p>
              <button
                @click="addToCart(lesson)"
                :disabled="lesson.spaces === 0"
                :class="[
                  'w-full py-2 px-4 rounded-lg font-semibold transition-colors duration-200 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',
                  lesson.spaces > 0
                    ? 'bg-blue-600 text-white hover:bg-blue-700 cursor-pointer'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                ]"
              >
                {{ lesson.spaces > 0 ? 'Add to Cart' : 'Out of Stock' }}
              </button>
            </div>
          </div>
          <div v-else class="text-center py-12">
            <p class="text-gray-500 text-lg">No lessons found matching your search.</p>
          </div>
        </div>

        <!-- Cart View -->
        <div v-else class="max-w-2xl mx-auto">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Shopping Cart</h2>
          
          <!-- Cart Items -->
          <div v-if="cart.length > 0" class="mb-6">
            <!-- Cart Item -->
            <div v-for="(item, index) in cart" :key="index" 
                 class="bg-white rounded-lg shadow-md p-4 mb-3 flex justify-between items-center hover:shadow-lg transition-shadow">
              <div class="flex items-center gap-4">
                <i :class="`fas ${item.icon} text-2xl text-blue-600`"></i>
                <div>
                  <h4 class="font-bold text-gray-800">{{ item.subject }}</h4>
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-map-marker-alt mr-1"></i>{{ item.location }}
                  </p>
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-pound-sign mr-1"></i>{{ item.price }}
                  </p>
                </div>
              </div>
              <button
                @click="removeFromCart(item)"
                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 font-semibold focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
              >
                <i class="fas fa-trash-alt mr-2"></i>Remove
              </button>
            </div>
            
            <!-- Total -->
            <div class="bg-white rounded-lg shadow-md p-4 mt-4">
              <div class="flex justify-between items-center text-xl font-bold">
                <span>Total:</span>
                <span>Â£{{ cartTotal }}</span>
              </div>
            </div>
          </div>
          <div v-else class="text-center py-12">
            <p class="text-gray-500 text-lg">Your cart is empty.</p>
          </div>

          <!-- Checkout Form -->
          <div v-if="cart.length > 0" class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Checkout</h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Name (letters only)
                </label>
                <input
                  v-model="checkoutName"
                  type="text"
                  placeholder="Enter your name"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  :class="{ 'border-red-500': checkoutName && !isNameValid }"
                />
                <p v-if="checkoutName && !isNameValid" class="text-red-500 text-sm mt-1">
                  Name must contain only letters and spaces
                </p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Phone (numbers only)
                </label>
                <input
                  v-model="checkoutPhone"
                  type="text"
                  placeholder="Enter your phone number"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  :class="{ 'border-red-500': checkoutPhone && !isPhoneValid }"
                />
                <p v-if="checkoutPhone && !isPhoneValid" class="text-red-500 text-sm mt-1">
                  Phone must contain only numbers
                </p>
              </div>

              <button
                @click="submitOrder"
                :disabled="!isCheckoutValid"
                :class="[
                  'w-full py-3 px-4 rounded-lg font-semibold transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',
                  isCheckoutValid
                    ? 'bg-blue-600 text-white hover:bg-blue-700 cursor-pointer'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                ]"
              >
                Submit Order
              </button>
            </div>

            <!-- Success Message -->
            <div v-if="orderSubmitted" class="mt-4 p-4 bg-green-100 border border-green-400 rounded-lg">
              <p class="text-green-700 font-semibold">
                <i class="fas fa-check-circle mr-2"></i>
                Order submitted successfully!
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Vue 2 App with CDN - CST3144 Coursework
    // Student: Mohammad Amaan Khan (M00986493)
    // Email: mk2310@live.mdx.ac.uk
    // Lecturer: Dr. Chinnu Mary George
    
    // Create Vue instance and mount to #app div
    new Vue({
      el: '#app',
      
      // Data function returns initial state
      data: function() {
        return {
          // API Configuration - Backend URL
          apiBaseUrl: 'https://cst3144-backend-f7yf.onrender.com',
          
          // State
          lessons: [],
          cart: [],
          showCart: false,
          searchQuery: '',
          sortBy: 'subject',
          sortOrder: 'asc',
          checkoutName: '',
          checkoutPhone: '',
          orderSubmitted: false,
          loading: true,
          errorMessage: '',
          errorMessageTitle: 'Something went wrong',
          
          // Debounce timer
          searchTimer: null,
        };
      },
      computed: {
        // Sorted and filtered lessons (10% marks - sort functionality)
        // This computed property automatically recalculates when lessons, sortBy, or sortOrder changes
        displayedLessons: function() {
          var self = this;
          // Create copy of lessons array before sorting (don't mutate original)
          var sorted = this.lessons.slice().sort(function(a, b) {
            var aValue = a[self.sortBy];
            var bValue = b[self.sortBy];
            
            if (typeof aValue === 'string') aValue = aValue.toLowerCase();
            if (typeof bValue === 'string') bValue = bValue.toLowerCase();
            
            if (aValue < bValue) return self.sortOrder === 'asc' ? -1 : 1;
            if (aValue > bValue) return self.sortOrder === 'asc' ? 1 : -1;
            return 0;
          });
          return sorted;
        },
        
        // Cart total price
        cartTotal: function() {
          return this.cart.reduce(function(total, item) {
            return total + item.price;
          }, 0);
        },
        
        // Validation: Name (letters only)
        isNameValid: function() {
          return /^[a-zA-Z\s]+$/.test(this.checkoutName);
        },
        
        // Validation: Phone (numbers only)
        isPhoneValid: function() {
          return /^[0-9]+$/.test(this.checkoutPhone);
        },
        
        // Checkout enabled when both valid
        isCheckoutValid: function() {
          return this.checkoutName && this.checkoutPhone && 
                 this.isNameValid && this.isPhoneValid;
        }
      },
      methods: {
        // Fetch all lessons from API (3% marks)
        // This function runs when page loads and when search is cleared
        fetchLessons: function() {
          var self = this;
          self.loading = true;
          
          // GET request to backend /lessons endpoint
          fetch(this.apiBaseUrl + '/lessons')
            .then(function(response) {
              if (!response.ok) throw new Error('Failed to fetch lessons');
              return response.json();
            })
            .then(function(data) {
              self.lessons = data;
              self.loading = false;
            })
            .catch(function(error) {
              console.error('Error fetching lessons:', error);
              self.errorMessageTitle = 'Failed to load lessons';
              self.errorMessage = 'Please check your connection and try again.';
              self.loading = false;
            });
        },
        
        // Search lessons with debounce
        handleSearch: function() {
          var self = this;
          
          // Clear existing timer
          if (this.searchTimer) {
            clearTimeout(this.searchTimer);
          }
          
          // Set new timer (300ms debounce)
          this.searchTimer = setTimeout(function() {
            self.performSearch();
          }, 300);
        },
        
        // Perform search API call
        performSearch: function() {
          var self = this;
          var query = this.searchQuery;
          
          if (!query) {
            this.fetchLessons();
            return;
          }
          
          fetch(this.apiBaseUrl + '/search?q=' + encodeURIComponent(query))
            .then(function(response) {
              if (!response.ok) throw new Error('Search failed');
              return response.json();
            })
            .then(function(data) {
              self.lessons = data;
            })
            .catch(function(error) {
              console.error('Error searching:', error);
              self.errorMessageTitle = 'Search failed';
              self.errorMessage = 'Please try again in a moment.';
            });
        },
        
        // Add lesson to cart
        addToCart: function(lesson) {
          if (lesson.spaces > 0) {
            // Add copy to cart
            this.cart.push(JSON.parse(JSON.stringify(lesson)));
            
            // Reduce available spaces
            var lessonIndex = this.lessons.findIndex(function(l) {
              return l._id === lesson._id;
            });
            if (lessonIndex !== -1) {
              this.lessons[lessonIndex].spaces--;
            }
          }
        },
        
        // Remove lesson from cart
        removeFromCart: function(item) {
          var self = this;
          
          // Remove from cart
          var cartIndex = this.cart.findIndex(function(i) {
            return i._id === item._id;
          });
          if (cartIndex !== -1) {
            this.cart.splice(cartIndex, 1);
          }
          
          // Restore spaces
          var lessonIndex = this.lessons.findIndex(function(l) {
            return l._id === item._id;
          });
          if (lessonIndex !== -1) {
            this.lessons[lessonIndex].spaces++;
          }
        },
        
        // Submit order
        submitOrder: function() {
          var self = this;
          
          // Prepare order data
          var orderData = {
            name: this.checkoutName,
            phone: this.checkoutPhone,
            lessonIds: this.cart.map(function(item) { return item._id; }),
            spaces: this.cart.length
          };
          
          // POST order to backend
          fetch(this.apiBaseUrl + '/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
          })
          .then(function(response) {
            if (!response.ok) throw new Error('Failed to submit order');
            return response.json();
          })
          .then(function(data) {
            // Update lesson spaces
            return self.updateLessonSpaces();
          })
          .then(function() {
            // Show success message
            self.orderSubmitted = true;
            
            // Clear cart after 2 seconds
            setTimeout(function() {
              self.cart = [];
              self.checkoutName = '';
              self.checkoutPhone = '';
              self.orderSubmitted = false;
              self.showCart = false;
              self.fetchLessons();
            }, 2000);
          })
          .catch(function(error) {
            console.error('Error submitting order:', error);
            self.errorMessageTitle = 'Order submission failed';
            self.errorMessage = 'Please review your details and try again.';
          });
        },
        
        // Update lesson spaces in database
        updateLessonSpaces: function() {
          var self = this;
          var promises = [];
          
          // Group cart items by lesson ID
          var lessonUpdates = {};
          this.cart.forEach(function(item) {
            if (!lessonUpdates[item._id]) {
              lessonUpdates[item._id] = {
                currentSpaces: item.spaces,
                count: 0
              };
            }
            lessonUpdates[item._id].count++;
          });
          
          // Update each lesson
          Object.keys(lessonUpdates).forEach(function(lessonId) {
            var update = lessonUpdates[lessonId];
            var newSpaces = update.currentSpaces - update.count;
            
            var promise = fetch(self.apiBaseUrl + '/lessons/' + lessonId, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ spaces: newSpaces })
            });
            
            promises.push(promise);
          });
          
          return Promise.all(promises);
        }
      },
      mounted: function() {
        // Restore persisted state
        try {
          var persisted = JSON.parse(localStorage.getItem('cst3144_frontend_state') || '{}');
          if (persisted && typeof persisted === 'object') {
            if (Array.isArray(persisted.cart)) this.cart = persisted.cart;
            if (typeof persisted.searchQuery === 'string') this.searchQuery = persisted.searchQuery;
            if (typeof persisted.sortBy === 'string') this.sortBy = persisted.sortBy;
            if (typeof persisted.sortOrder === 'string') this.sortOrder = persisted.sortOrder;
            if (typeof persisted.showCart === 'boolean') this.showCart = persisted.showCart;
          }
        } catch (e) {
          console.warn('Failed to restore persisted state', e);
        }

        // Fetch lessons when page loads
        this.fetchLessons();
      },
      watch: {
        cart: {
          deep: true,
          handler: function() { this.persistState(); }
        },
        searchQuery: function() { this.persistState(); },
        sortBy: function() { this.persistState(); },
        sortOrder: function() { this.persistState(); },
        showCart: function() { this.persistState(); }
      },
      // Instance method to persist state
      persistState: function() {
        try {
          var snapshot = {
            cart: this.cart,
            searchQuery: this.searchQuery,
            sortBy: this.sortBy,
            sortOrder: this.sortOrder,
            showCart: this.showCart
          };
          localStorage.setItem('cst3144_frontend_state', JSON.stringify(snapshot));
        } catch (e) {
          console.warn('Failed to persist state', e);
        }
      }
    });
  </script>
</body>
</html>

