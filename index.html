<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>After-School Lessons</title>
  <meta name="description" content="CST3144 After-School Lessons app built with Vue 2 (CDN). Browse, search, sort and book lessons with a simple cart and checkout.">
  <meta name="theme-color" content="#1e3a5f">
  <link rel="icon" href="https://fav.farm/ðŸŽ“" />
  
  <!-- Geist Font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/geist@1.2.0/dist/fonts/geist-sans/style.min.css">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome (UI icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Vue 2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'geist': ['Geist', 'system-ui', 'sans-serif'],
          },
          colors: {
            navy: {
              50: '#f0f5fa',
              100: '#d9e4f0',
              200: '#b3c9e0',
              300: '#8daed1',
              400: '#5c8bbf',
              500: '#3b6ea8',
              600: '#2d5a8a',
              700: '#1e3a5f',
              800: '#162c47',
              900: '#0f1e30',
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Base Styles */
    html { scroll-behavior: smooth; }
    
    body {
      font-family: 'Geist', system-ui, sans-serif;
      background: #ffffff;
      min-height: 100vh;
    }

    /* Glass Card Effect */
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 20px rgba(30, 58, 95, 0.1);
    }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeInUp 0.5s ease-out forwards; }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    .animate-float { animation: float 3s ease-in-out infinite; }

    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin-slow { animation: spin 1.5s linear infinite; }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #2d5a8a 0%, #3b6ea8 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(45, 90, 138, 0.3);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(45, 90, 138, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
    }

    .btn-disabled {
      background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%);
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Inputs */
    .input-modern {
      transition: all 0.3s ease;
      border: 2px solid #e5e7eb;
    }
    .input-modern:focus {
      border-color: #3b6ea8;
      box-shadow: 0 0 0 3px rgba(59, 110, 168, 0.15);
      outline: none;
    }
    .input-modern.input-error {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
    }

    /* Card Hover */
    .lesson-card {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .lesson-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 30px rgba(30, 58, 95, 0.15);
    }
    .lesson-card:hover .subject-image {
      transform: scale(1.05);
    }
    .subject-image { transition: transform 0.3s ease; }

    /* Radio Buttons */
    .radio-custom {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #b3c9e0;
      border-radius: 50%;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
    }
    .radio-custom:checked {
      border-color: #2d5a8a;
      background: #2d5a8a;
    }
    .radio-custom:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
    }
    .radio-custom:hover { border-color: #3b6ea8; }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      font-size: 0.7rem;
      font-weight: 700;
      border-radius: 9999px;
      background: #fbbf24;
      color: #1e3a5f;
    }

    /* Success Animation */
    @keyframes successPop {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .success-message { animation: successPop 0.3s ease-out forwards; }
  </style>
</head>

<body class="font-geist text-gray-800 antialiased">
  <div id="app">
    <div class="min-h-screen py-8 px-4 sm:py-12 sm:px-6 lg:px-8">
      <div class="max-w-7xl mx-auto">

        <!-- Error Banner -->
        <div v-if="errorMessage" class="mb-6 glass-card rounded-xl p-4 border-l-4 border-red-500 animate-fade-in">
          <div class="flex items-start justify-between gap-4">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-full bg-red-100 flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-red-500"></i>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">{{ errorMessageTitle }}</h3>
                <p class="text-gray-600 text-sm">{{ errorMessage }}</p>
              </div>
            </div>
            <button @click="errorMessage = ''" class="text-gray-400 hover:text-gray-600 p-1">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Header -->
        <header class="text-center mb-10 animate-fade-in">
          <div class="inline-flex items-center justify-center w-14 h-14 rounded-xl bg-navy-700 mb-5 animate-float">
            <i class="fas fa-graduation-cap text-2xl text-white"></i>
          </div>
          
          <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 mb-3">
            After-School Lessons
          </h1>
          
          <p class="text-gray-700 text-lg max-w-md mx-auto">
            Discover and book enriching after-school classes for your children
          </p>
        </header>

        <!-- Cart Toggle -->
        <div class="flex justify-end mb-8 animate-fade-in" style="animation-delay: 0.1s;">
          <button
            @click="showCart = !showCart"
            :disabled="!showCart && cart.length === 0"
            :class="[
              'flex items-center gap-2 px-5 py-3 rounded-lg font-semibold transition-all',
              showCart || cart.length > 0 ? 'btn-secondary text-white' : 'btn-disabled text-gray-500'
            ]"
          >
            <i :class="showCart ? 'fas fa-store' : 'fas fa-shopping-cart'"></i>
            <span>{{ showCart ? 'View Lessons' : 'View Cart' }}</span>
            <span v-if="cart.length > 0" class="badge">{{ cart.length }}</span>
          </button>
        </div>

        <!-- Lessons View -->
        <div v-if="!showCart">
          
          <!-- Search -->
          <div class="glass-card rounded-xl p-5 mb-5 animate-fade-in" style="animation-delay: 0.15s;">
            <label for="search" class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-search text-navy-500 mr-2"></i>Search Lessons
            </label>
            <div class="relative">
              <input
                id="search"
                type="text"
                v-model="searchQuery"
                @input="handleSearch"
                placeholder="Search by subject, location, price, or spaces..."
                class="w-full px-4 py-3 rounded-lg input-modern text-gray-800"
              />
              <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <p v-if="searchQuery" class="text-sm text-gray-600 mt-2">
              <i class="fas fa-filter text-xs mr-1"></i>Results for: <strong>"{{ searchQuery }}"</strong>
            </p>
          </div>

          <!-- Sort -->
          <div class="glass-card rounded-xl p-5 mb-6 animate-fade-in" style="animation-delay: 0.2s;">
            <h3 class="text-base font-bold text-gray-800 mb-4">
              <i class="fas fa-sliders text-navy-500 mr-2"></i>Sort Options
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Attribute</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="sortAttr" value="subject" v-model="sortBy" class="radio-custom" />
                    <span class="text-gray-700">Subject</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="sortAttr" value="location" v-model="sortBy" class="radio-custom" />
                    <span class="text-gray-700">Location</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="sortAttr" value="price" v-model="sortBy" class="radio-custom" />
                    <span class="text-gray-700">Price</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="sortAttr" value="spaces" v-model="sortBy" class="radio-custom" />
                    <span class="text-gray-700">Availability</span>
                  </label>
                </div>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Order</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="sortOrder" value="asc" v-model="sortOrder" class="radio-custom" />
                    <span class="text-gray-700"><i class="fas fa-arrow-up-short-wide mr-1 text-navy-400"></i>Ascending</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="sortOrder" value="desc" v-model="sortOrder" class="radio-custom" />
                    <span class="text-gray-700"><i class="fas fa-arrow-down-wide-short mr-1 text-navy-400"></i>Descending</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading -->
          <div v-if="loading" class="text-center py-16 animate-fade-in">
            <div class="inline-flex items-center justify-center w-14 h-14 rounded-xl bg-navy-700 mb-4">
              <i class="fas fa-circle-notch text-2xl text-white animate-spin-slow"></i>
            </div>
            <p class="text-gray-600 text-lg">Loading lessons...</p>
          </div>

          <!-- Lessons Grid -->
          <div v-else-if="displayedLessons.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <div v-for="(lesson, index) in displayedLessons" 
                 :key="lesson._id" 
                 class="lesson-card glass-card rounded-xl animate-fade-in"
                 :style="'animation-delay: ' + (0.05 * index) + 's'">
              
              <!-- Image -->
              <div class="h-44 overflow-hidden rounded-t-xl">
                <img :src="getSubjectImage(lesson.subject)" :alt="lesson.subject" class="subject-image w-full h-full object-cover" />
              </div>
              
              <!-- Content -->
              <div class="p-5">
                <h3 class="text-xl font-bold text-gray-900 mb-3">{{ lesson.subject }}</h3>
                
                <div class="space-y-2 mb-4 text-sm">
                  <p class="flex items-center gap-2 text-gray-600">
                    <span class="w-7 h-7 rounded bg-navy-100 flex items-center justify-center">
                      <i class="fas fa-map-marker-alt text-navy-600 text-xs"></i>
                    </span>
                    {{ lesson.location }}
                  </p>
                  <p class="flex items-center gap-2 text-gray-600">
                    <span class="w-7 h-7 rounded bg-navy-100 flex items-center justify-center">
                      <i class="fas fa-pound-sign text-navy-600 text-xs"></i>
                    </span>
                    <span class="font-semibold text-gray-800">Â£{{ lesson.price }}</span>
                  </p>
                  <p class="flex items-center gap-2" :class="lesson.spaces === 0 ? 'text-red-500' : 'text-gray-600'">
                    <span class="w-7 h-7 rounded flex items-center justify-center" :class="lesson.spaces === 0 ? 'bg-red-100' : 'bg-navy-100'">
                      <i class="fas fa-users text-xs" :class="lesson.spaces === 0 ? 'text-red-500' : 'text-navy-600'"></i>
                    </span>
                    <span :class="lesson.spaces === 0 ? 'font-semibold' : ''">{{ lesson.spaces }} spaces</span>
                  </p>
                </div>
                
                <button
                  @click="addToCart(lesson)"
                  :disabled="lesson.spaces === 0"
                  :class="[
                    'w-full py-3 rounded-lg font-semibold transition-all',
                    lesson.spaces > 0 ? 'btn-primary text-white' : 'btn-disabled text-gray-500'
                  ]"
                >
                  <i :class="lesson.spaces > 0 ? 'fas fa-cart-plus mr-2' : 'fas fa-ban mr-2'"></i>
                  {{ lesson.spaces > 0 ? 'Add to Cart' : 'Out of Stock' }}
                </button>
              </div>
            </div>
          </div>

          <!-- No Results -->
          <div v-else class="text-center py-16 animate-fade-in">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl bg-gray-200 mb-4">
              <i class="fas fa-search-minus text-3xl text-gray-400"></i>
            </div>
            <p class="text-gray-600 text-lg">No lessons found.</p>
            <p class="text-gray-500 text-sm mt-1">Try adjusting your search</p>
          </div>
        </div>

        <!-- Cart View -->
        <div v-else class="max-w-2xl mx-auto">
          <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2 animate-fade-in">
            <i class="fas fa-shopping-cart text-navy-600"></i>Shopping Cart
          </h2>
          
          <div v-if="cart.length > 0" class="mb-5 space-y-3">
            <div v-for="(item, index) in cart" :key="index" 
                 class="glass-card rounded-xl p-4 flex justify-between items-center gap-3 animate-fade-in"
                 :style="'animation-delay: ' + (0.05 * index) + 's'">
              <div class="flex items-center gap-3">
                <div class="w-14 h-14 rounded-lg overflow-hidden flex-shrink-0">
                  <img :src="getSubjectImage(item.subject)" :alt="item.subject" class="w-full h-full object-cover" />
                </div>
                <div>
                  <h4 class="font-bold text-gray-900">{{ item.subject }}</h4>
                  <p class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>{{ item.location }}</p>
                  <p class="text-sm font-semibold text-navy-600">Â£{{ item.price }}</p>
                </div>
              </div>
              <button @click="removeFromCart(item)" class="btn-danger text-white px-3 py-2 rounded-lg font-semibold text-sm">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            
            <div class="glass-card rounded-xl p-4 mt-4">
              <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-700">Total</span>
                <span class="text-2xl font-bold text-navy-700">Â£{{ cartTotal }}</span>
              </div>
            </div>
          </div>

          <div v-else class="text-center py-16 animate-fade-in">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl bg-gray-200 mb-4">
              <i class="fas fa-shopping-basket text-3xl text-gray-400"></i>
            </div>
            <p class="text-gray-600 text-lg">Your cart is empty</p>
          </div>

          <!-- Checkout -->
          <div v-if="cart.length > 0" class="glass-card rounded-xl p-5 animate-fade-in" style="animation-delay: 0.15s;">
            <h3 class="text-xl font-bold text-gray-900 mb-5">
              <i class="fas fa-credit-card text-navy-500 mr-2"></i>Checkout
            </h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                  <i class="fas fa-user text-navy-400 mr-1"></i>Name <span class="font-normal text-gray-400">(letters only)</span>
                </label>
                <input
                  v-model="checkoutName"
                  type="text"
                  placeholder="Enter your name"
                  class="w-full px-4 py-3 rounded-lg input-modern"
                  :class="{ 'input-error': checkoutName && !isNameValid }"
                />
                <p v-if="checkoutName && !isNameValid" class="text-red-500 text-xs mt-1">
                  <i class="fas fa-exclamation-circle mr-1"></i>Letters and spaces only
                </p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                  <i class="fas fa-phone text-navy-400 mr-1"></i>Phone <span class="font-normal text-gray-400">(numbers only)</span>
                </label>
                <input
                  v-model="checkoutPhone"
                  type="text"
                  placeholder="Enter your phone number"
                  class="w-full px-4 py-3 rounded-lg input-modern"
                  :class="{ 'input-error': checkoutPhone && !isPhoneValid }"
                />
                <p v-if="checkoutPhone && !isPhoneValid" class="text-red-500 text-xs mt-1">
                  <i class="fas fa-exclamation-circle mr-1"></i>Numbers only
                </p>
              </div>

              <button
                @click="submitOrder"
                :disabled="!isCheckoutValid"
                :class="[
                  'w-full py-3 rounded-lg font-bold text-lg transition-all mt-2',
                  isCheckoutValid ? 'btn-primary text-white' : 'btn-disabled text-gray-500'
                ]"
              >
                <i class="fas fa-paper-plane mr-2"></i>Submit Order
              </button>
            </div>

            <div v-if="orderSubmitted" class="mt-5 p-4 bg-green-50 border border-green-200 rounded-lg success-message">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-green-500 flex items-center justify-center">
                  <i class="fas fa-check text-white"></i>
                </div>
                <div>
                  <p class="text-green-800 font-bold">Order submitted!</p>
                  <p class="text-green-600 text-sm">Redirecting...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 pb-6">
          <p class="text-gray-500 text-sm">
            Built with <i class="fas fa-heart text-red-400 mx-1"></i> for CST3144 Coursework
          </p>
        </footer>

      </div>
    </div>
  </div>

  <script>
    // Vue 2 App - CST3144 Coursework
    // Student: Mohammad Amaan Khan (M00986493)
    
    new Vue({
      el: '#app',
      
      data: function() {
        return {
          apiBaseUrl: 'https://cst3144-backend-f7yf.onrender.com',
          
          // Subject images mapping
          subjectImages: {
            'Art': 'europeana-rMV45VgcRbQ-unsplash.jpg',
            'Music': 'igor-omilaev-0d7is4rDYIA-unsplash.jpg',
            'English': 'jacinta-christos-nyOIF_y4gxg-unsplash.jpg',
            'Math': 'mila-tovar-8UDKMqyOTqs-unsplash.jpg',
            'Maths': 'mila-tovar-8UDKMqyOTqs-unsplash.jpg',
            'Science': 'nasa-rTZW4f02zY8-unsplash.jpg'
          },
          
          lessons: [],
          cart: [],
          showCart: false,
          searchQuery: '',
          sortBy: 'subject',
          sortOrder: 'asc',
          checkoutName: '',
          checkoutPhone: '',
          orderSubmitted: false,
          loading: true,
          errorMessage: '',
          errorMessageTitle: 'Something went wrong',
          searchTimer: null
        };
      },

      computed: {
        displayedLessons: function() {
          var self = this;
          return this.lessons.slice().sort(function(a, b) {
            var aVal = a[self.sortBy];
            var bVal = b[self.sortBy];
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();
            if (aVal < bVal) return self.sortOrder === 'asc' ? -1 : 1;
            if (aVal > bVal) return self.sortOrder === 'asc' ? 1 : -1;
            return 0;
          });
        },
        
        cartTotal: function() {
          return this.cart.reduce(function(sum, item) { return sum + item.price; }, 0);
        },
        
        isNameValid: function() {
          return /^[a-zA-Z\s]+$/.test(this.checkoutName);
        },
        
        isPhoneValid: function() {
          return /^[0-9]+$/.test(this.checkoutPhone);
        },
        
        isCheckoutValid: function() {
          return this.checkoutName && this.checkoutPhone && this.isNameValid && this.isPhoneValid;
        }
      },

      methods: {
        getSubjectImage: function(subject) {
          return this.subjectImages[subject] || 'nasa-rTZW4f02zY8-unsplash.jpg';
        },
        
        fetchLessons: function() {
          var self = this;
          self.loading = true;
          fetch(this.apiBaseUrl + '/lessons')
            .then(function(res) {
              if (!res.ok) throw new Error('Failed to fetch');
              return res.json();
            })
            .then(function(data) {
              self.lessons = data;
              self.loading = false;
            })
            .catch(function(err) {
              self.errorMessageTitle = 'Failed to load lessons';
              self.errorMessage = 'Please check your connection.';
              self.loading = false;
            });
        },
        
        handleSearch: function() {
          var self = this;
          if (this.searchTimer) clearTimeout(this.searchTimer);
          this.searchTimer = setTimeout(function() { self.performSearch(); }, 300);
        },
        
        performSearch: function() {
          var self = this;
          if (!this.searchQuery) { this.fetchLessons(); return; }
          fetch(this.apiBaseUrl + '/search?q=' + encodeURIComponent(this.searchQuery))
            .then(function(res) {
              if (!res.ok) throw new Error('Search failed');
              return res.json();
            })
            .then(function(data) { self.lessons = data; })
            .catch(function(err) {
              self.errorMessageTitle = 'Search failed';
              self.errorMessage = 'Please try again.';
            });
        },
        
        addToCart: function(lesson) {
          if (lesson.spaces > 0) {
            this.cart.push(JSON.parse(JSON.stringify(lesson)));
            var idx = this.lessons.findIndex(function(l) { return l._id === lesson._id; });
            if (idx !== -1) this.lessons[idx].spaces--;
          }
        },
        
        removeFromCart: function(item) {
          var cartIdx = this.cart.findIndex(function(i) { return i._id === item._id; });
          if (cartIdx !== -1) this.cart.splice(cartIdx, 1);
          var lessonIdx = this.lessons.findIndex(function(l) { return l._id === item._id; });
          if (lessonIdx !== -1) this.lessons[lessonIdx].spaces++;
        },
        
        submitOrder: function() {
          var self = this;
          var orderData = {
            name: this.checkoutName,
            phone: this.checkoutPhone,
            lessonIds: this.cart.map(function(item) { return item._id; }),
            spaces: this.cart.length
          };
          
          fetch(this.apiBaseUrl + '/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
          })
          .then(function(res) {
            if (!res.ok) throw new Error('Order failed');
            return res.json();
          })
          .then(function() { return self.updateLessonSpaces(); })
          .then(function() {
            self.orderSubmitted = true;
            setTimeout(function() {
              self.cart = [];
              self.checkoutName = '';
              self.checkoutPhone = '';
              self.orderSubmitted = false;
              self.showCart = false;
              self.fetchLessons();
            }, 2000);
          })
          .catch(function(err) {
            self.errorMessageTitle = 'Order failed';
            self.errorMessage = 'Please try again.';
          });
        },
        
        updateLessonSpaces: function() {
          var self = this;
          var updates = {};
          this.cart.forEach(function(item) {
            if (!updates[item._id]) updates[item._id] = { spaces: item.spaces, count: 0 };
            updates[item._id].count++;
          });
          
          var promises = Object.keys(updates).map(function(id) {
            return fetch(self.apiBaseUrl + '/lessons/' + id, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ spaces: updates[id].spaces - updates[id].count })
            });
          });
          return Promise.all(promises);
        },
        
        persistState: function() {
          try {
            localStorage.setItem('cst3144_state', JSON.stringify({
              cart: this.cart, searchQuery: this.searchQuery,
              sortBy: this.sortBy, sortOrder: this.sortOrder, showCart: this.showCart
            }));
          } catch (e) {}
        }
      },

      mounted: function() {
        try {
          var saved = JSON.parse(localStorage.getItem('cst3144_state') || '{}');
          if (saved.cart) this.cart = saved.cart;
          if (saved.searchQuery) this.searchQuery = saved.searchQuery;
          if (saved.sortBy) this.sortBy = saved.sortBy;
          if (saved.sortOrder) this.sortOrder = saved.sortOrder;
          if (saved.showCart !== undefined) this.showCart = saved.showCart;
        } catch (e) {}
        this.fetchLessons();
      },

      watch: {
        cart: { deep: true, handler: function() { this.persistState(); } },
        searchQuery: function() { this.persistState(); },
        sortBy: function() { this.persistState(); },
        sortOrder: function() { this.persistState(); },
        showCart: function() { this.persistState(); }
      }
    });
  </script>
</body>
</html>
